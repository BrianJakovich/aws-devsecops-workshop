{"AWSTemplateFormatVersion":"2010-09-09","Description":"AWS DevSecOps Workshop Environment + Jenkins (VPC+EC2 Instance)","Parameters":{"InstanceType":{"Type":"String","Description":"EC2 Instance Type to deploy.","Default":"t2.micro"},"WorldCIDR":{"Type":"String","Description":"The CIDR block to allow HTTP access to Jenkins with.","Default":"0.0.0.0/0"},"GithubCIDR":{"Type":"String","Description":"The CIDR block to allow HTTP access to Jenkins with.","Default":"192.30.252.0/22"}},"Resources":{"VPC":{"Properties":{"CidrBlock":"11.0.0.0/16","EnableDnsSupport":"true","EnableDnsHostnames":"true","Tags":[{"Key":"Name","Value":{"Ref":"AWS::StackName"}}]},"Type":"AWS::EC2::VPC"},"Subnet":{"Properties":{"VpcId":{"Ref":"VPC"},"CidrBlock":"11.0.0.0/20","MapPublicIpOnLaunch":true,"Tags":[{"Key":"Name","Value":{"Ref":"AWS::StackName"}}]},"Type":"AWS::EC2::Subnet"},"InternetGateway":{"Properties":{"Tags":[{"Key":"Name","Value":{"Ref":"AWS::StackName"}}]},"Type":"AWS::EC2::InternetGateway"},"AttachGateway":{"Properties":{"VpcId":{"Ref":"VPC"},"InternetGatewayId":{"Ref":"InternetGateway"}},"Type":"AWS::EC2::VPCGatewayAttachment"},"RouteTable":{"Properties":{"VpcId":{"Ref":"VPC"},"Tags":[{"Key":"Name","Value":{"Ref":"AWS::StackName"}}]},"Type":"AWS::EC2::RouteTable"},"Route":{"DependsOn":"AttachGateway","Properties":{"RouteTableId":{"Ref":"RouteTable"},"DestinationCidrBlock":{"Ref":"WorldCIDR"},"GatewayId":{"Ref":"InternetGateway"}},"Type":"AWS::EC2::Route"},"SubnetAssociation":{"Properties":{"SubnetId":{"Ref":"Subnet"},"RouteTableId":{"Ref":"RouteTable"}},"Type":"AWS::EC2::SubnetRouteTableAssociation"},"JenkinsSecurityGroup":{"Properties":{"VpcId":{"Ref":"VPC"},"GroupDescription":"AWS DevSecOps Workshop Jenkins","SecurityGroupIngress":[{"IpProtocol":"tcp","FromPort":"8080","ToPort":"8080","CidrIp":{"Ref":"WorldCIDR"}}],"SecurityGroupEgress":[{"IpProtocol":"tcp","FromPort":"22","ToPort":"22","CidrIp":"11.0.0.0/20"},{"IpProtocol":"tcp","FromPort":"80","ToPort":"80","CidrIp":{"Ref":"WorldCIDR"}},{"IpProtocol":"tcp","FromPort":"443","ToPort":"443","CidrIp":{"Ref":"WorldCIDR"}},{"IpProtocol":"tcp","FromPort":"22","ToPort":"22","CidrIp":{"Ref":"GithubCIDR"}},{"IpProtocol":"tcp","FromPort":"9418","ToPort":"9418","CidrIp":{"Ref":"GithubCIDR"}}]},"Type":"AWS::EC2::SecurityGroup"},"JenkinsConnector":{"Properties":{"GroupDescription":"AWS DevSecOps Workshop Jenkins Connector","VpcId":{"Ref":"VPC"},"SecurityGroupIngress":[{"IpProtocol":"tcp","FromPort":"22","ToPort":"22","SourceSecurityGroupId":{"Ref":"JenkinsSecurityGroup"}},{"IpProtocol":"tcp","FromPort":"80","ToPort":"80","SourceSecurityGroupId":{"Ref":"JenkinsSecurityGroup"}},{"IpProtocol":"tcp","FromPort":"8080","ToPort":"8080","SourceSecurityGroupId":{"Ref":"JenkinsSecurityGroup"}}],"SecurityGroupEgress":[{"IpProtocol":"tcp","FromPort":"22","ToPort":"22","DestinationSecurityGroupId":{"Ref":"JenkinsSecurityGroup"}},{"IpProtocol":"tcp","FromPort":"80","ToPort":"80","DestinationSecurityGroupId":{"Ref":"JenkinsSecurityGroup"}},{"IpProtocol":"tcp","FromPort":"443","ToPort":"443","DestinationSecurityGroupId":{"Ref":"JenkinsSecurityGroup"}},{"IpProtocol":"tcp","FromPort":"8080","ToPort":"8080","DestinationSecurityGroupId":{"Ref":"JenkinsSecurityGroup"}}]},"Type":"AWS::EC2::SecurityGroup"},"WaitHandle":{"Type":"AWS::CloudFormation::WaitConditionHandle"},"EC2Waiter":{"DependsOn":"JenkinsServer","Properties":{"Handle":{"Ref":"WaitHandle"},"Timeout":"600"},"Type":"AWS::CloudFormation::WaitCondition"},"JenkinsServer":{"Properties":{"ImageId":"ami-9e376e89","InstanceType":{"Ref":"InstanceType"},"IamInstanceProfile":{"Ref":"JenkinsInstanceProfile"},"NetworkInterfaces":[{"AssociatePublicIpAddress":true,"DeleteOnTermination":true,"SubnetId":{"Ref":"Subnet"},"DeviceIndex":0,"GroupSet":[{"Ref":"JenkinsSecurityGroup"}]}],"Tags":[{"Key":"Name","Value":{"Fn::Join":[" - ",["AWS DevSecOps Workshop - Jenkins","ROBERT"]]}}],"UserData":{"Fn::Base64":{"Fn::Join":["",["#!/bin/bash\n","export wait_handle=\"",{"Ref":"WaitHandle"},"\"\n","export vpc_id=\"",{"Ref":"VPC"},"\"\n","export subnet_id=\"",{"Ref":"Subnet"},"\"\n","export world_cidr=\"",{"Ref":"WorldCIDR"},"\"\n","#!/bin/bash\n","set -ex\n","\n","# Update Jenkins with some build parameters\n","sed -i.bak \"s#VPCID_TOKEN#${vpc_id}#g\" /var/lib/jenkins/config.xml\n","sed -i.bak \"s#SUBNETID_TOKEN#${subnet_id}#g\" /var/lib/jenkins/config.xml\n","sed -i.bak \"s#0.0.0.0/0#${world_cidr}#g\" /var/lib/jenkins/config.xml\n","\n","# Restart Jenkins\n","service jenkins restart\n","sleep 30s\n","\n","# Create the CloudFormation wait handle JSON\n","cat > /tmp/cfn-success <<CFNSUCCESS\n","{\n","   \"Status\" : \"SUCCESS\",\n","   \"Reason\" : \"Configuration Complete\",\n","   \"UniqueId\" : \"$(uuidgen)\",\n","   \"Data\" : \"Application has completed configuration.\"\n","}\n","CFNSUCCESS\n","\n","# Emit success to CloudFormation\n","curl -T /tmp/cfn-success \"${wait_handle}\"\n"]]}}},"Type":"AWS::EC2::Instance","DependsOn":"AttachGateway"},"JenkinsRole":{"Properties":{"AssumeRolePolicyDocument":{"Statement":[{"Effect":"Allow","Principal":{"Service":["ec2.amazonaws.com"]},"Action":["sts:AssumeRole"]}]},"Path":"/","Policies":[{"PolicyName":"aws-devsecops-jenkins-role","PolicyDocument":{"Statement":[{"Effect":"Allow","Action":"cloudformation:*","Resource":"*"},{"Effect":"Allow","Action":"ec2:*","Resource":"*"},{"Effect":"Allow","Action":"inspector:*","Resource":"*"}]}}]},"Type":"AWS::IAM::Role"},"JenkinsInstanceProfile":{"Properties":{"Path":"/","Roles":[{"Ref":"JenkinsRole"}]},"Type":"AWS::IAM::InstanceProfile"},"InspectorRole":{"Properties":{"AssumeRolePolicyDocument":{"Statement":[{"Effect":"Allow","Principal":{"Service":["inspector.amazonaws.com"]},"Action":["sts:AssumeRole"],"Condition":{"StringEquals":{"sts:ExternalId":{"Ref":"AWS::AccountId"}}}}]},"Path":"/","Policies":[{"PolicyName":"aws-devsecops-inspector-role","PolicyDocument":{"Statement":[{"Effect":"Allow","Action":"ec2:DescribeInstances","Resource":"*"}]}}]},"Type":"AWS::IAM::Role"}},"Outputs":{"JenkinsIP":{"Value":{"Fn::GetAtt":["JenkinsServer","PublicIp"]}},"InspectorRoleArn":{"Value":{"Fn::GetAtt":["InspectorRole","Arn"]}}}}